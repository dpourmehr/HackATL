(function(n){function r(t){var r=new n.Deferred,u=window.screenX+(window.outerWidth-t.width)/2,f=window.screenY+(window.outerHeight-t.height)/2,e="status=0,resizable=0,scrollbars=1,location=0,toolbar=0,menubar=0,titlebar=0,left= "+u+",top="+f+",height="+t.height+",width="+t.width,i=window.open(t.url,"Authenticate",e),o=setInterval(function(){try{if(i.location.href.indexOf(t.redirectUri)>=0){var n={href:i.location.href,hash:i.location.hash,search:i.location.search};setTimeout(function(){r.resolve(n)},1e3);i.close();i=null;clearInterval(o)}}catch(u){}},1e3);return r.promise()}function i(){var n,i=(new Date).getTime();if(t.principal&&t.principal!==undefined){if(n=t.principal.token,n&&n.access_token&&n.expiry>i)return n}else if(n=JSON.parse(sessionStorage.getItem("access_token")),n&&n.access_token&&n.expiry>i)return n;t.principal.token=null;t.principal.isAuthenticated=!1;sessionStorage.removeItem("access_token");t.oauthParameters.manualSignIn||t.signIn()}function f(n){return n&&n.access_token&&n.access_token!==""&&(t.principal.token={access_token:n.access_token,expiry:(new Date).getTime()+n.expires_in*1e3,scope:n.scope},t.principal.isAuthenticated=!0,t.principal.isVerified=n.resource_owner_identity_verified==="1",sessionStorage.setItem("access_token",t.principal.token)),null}function u(i){var r=new n.Deferred,o,u;if(i&&i!==""||(i=window.location.hash),i&&i!==""){if(o=e(i),f(o),t.principal.isAuthenticated)return n.when(t.getProfile(),t.getRoles()).then(function(){r.resolve()}),u=o.state,window.location.hash=u&&u!==""?u:"",r.promise()}else t.oauthParameters.manualSignIn||t.signIn(),r.resolve();return r.promise()}function e(n){var t,u,i,r;if((n[0]==="?"||n[0]==="#")&&(n=n.substr(1,n.length-1)),n[0]==="/"&&(n=n.substr(1,n.length-1)),t=n.split("&"),u=[],t&&t.length>0)for(i=0;i<t.length;i++)r=t[i].split("="),r.length===2&&(u[r[0]]=decodeURIComponent(r[1]));return u}var t={oauthParameters:{clientId:"",baseUrl:"",redirectUri:"",scopes:"",manualSignIn:!0,popup:!1},principal:{isAuthenticated:!1,isVerified:!1,token:null,identity:null,roles:[],isInRole:function(i){if(!t.principal.isAuthenticated||t.principal.roles.length===0)return!1;var r=!1;return n.each(t.principal.roles,function(n,t){return r=t.name===i,!r}),r}}};t.config=function(i){var r;if(t.oauthParameters=n.extend(t.oauthParameters,i),r=t.oauthParameters.baseUrl,typeof r!="string")throw{error:"The baseUrl is required."};return r=r.trim(),r[r.length-1]==="/"&&(r=r.substring(0,r.length-1)),t.oauthParameters.baseUrl=r,u().then(function(){t.principal.isAuthenticated||t.oauthParameters.manualSignIn||t.signIn()})};t.signIn=function(i){var e=new n.Deferred,f=t.oauthParameters.baseUrl+"/oauth2/v1/auth?response_type=token&client_id="+encodeURIComponent(t.oauthParameters.clientId)+"&redirect_uri="+encodeURIComponent(t.oauthParameters.redirectUri);return t.oauthParameters.scopes!==undefined&&(f+="&scope="+encodeURIComponent(t.oauthParameters.scopes)),f+=i&&i!==""?"&state="+encodeURIComponent(i):"&state="+encodeURIComponent(window.location.hash),t.oauthParameters.popup?r({url:f,redirectUri:t.oauthParameters.redirectUri,width:600,height:500}).then(function(n){u(n.hash).then(function(){e.resolve()})}):window.location.href=f,e.promise()};t.signOut=function(){var r=new n.Deferred,u=i();return sessionStorage.removeItem("access_token"),t.principal.isAuthenticated=!1,t.principal.isVerified=!1,t.principal.identity=null,n.ajax({type:"POST",url:t.oauthParameters.baseUrl+"/oauth2/v1/revoke",data:n.param({token:u.access_token,token_type_hint:"access_token",client_id:t.oauthParameters.clientId}),beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+u.access_token)}}).success(function(n){r.resolve(n)}).error(function(n){r.reject(n)}),r.promise()};t.getProfile=function(){var r=new n.Deferred,u=i();return n.ajax(t.oauthParameters.baseUrl+"/api/identity/v1/",{type:"GET",beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+u.access_token)}}).success(function(n){t.principal.identity=n;r.resolve(n)}).error(function(n){r.reject(n)}),r.promise()};t.getFriends=function(){var r=new n.Deferred,u=i();return n.ajax(t.oauthParameters.baseUrl+"/api/identity/v1/friends",{type:"GET",beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+u.access_token)}}).success(function(n){r.resolve(n)}).error(function(n){r.reject(n)}),r.promise()};t.getAccounts=function(){var r=new n.Deferred,u=i();return n.ajax(t.oauthParameters.baseUrl+"/api/identity/v1/accounts",{type:"GET",beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+u.access_token)}}).success(function(n){r.resolve(n)}).error(function(n){r.reject(n)}),r.promise()};t.getRoles=function(){var r=new n.Deferred,u=i();return n.ajax(t.oauthParameters.baseUrl+"/api/identity/v1/accounts",{type:"GET",beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+u.access_token)}}).success(function(n){t.principal.roles=n;r.resolve(n)}).error(function(n){r.reject(n)}),r.promise};t.requireTwoFactorAuthentication=function(){var u=new n.Deferred,f=i();return t.principal.isVerified?(u.resolve(!0),u.promise()):(n.ajax(t.oauthParameters.baseUrl+"/oauth2/v1/verify",{type:"GET",beforeSend:function(n){n.setRequestHeader("Authorization","Bearer "+f.access_token)}}).success(function(n){if(n&&n.resource_owner_identity_verified)t.principal.isVerified=!0,u.resolve(!0);else{var i=t.oauthParameters.baseUrl+"/Authenticate/PerformTwoFactorAuthenticationVerification?accessToken="+f.access_token+"&clientId="+_this.oauthParameters.clientId+"&returnUrl="+encodeURIComponent(_this.oauthParameters.redirectUri);r({url:i,redirectUri:t.oauthParameters.redirectUri,width:600,height:500}).then(function(n){var i="resource_owner_identity_verified=",r=n.href.indexOf(i),f;r!=-1&&n.href.length>=r+(i.length+1)?(f=n.href[r+i.length]=="1",t.principal.isVerified=f,u.resolve(f)):u.resolve(!1)})}}).error(function(n){u.reject(n)}),u.promise())};t.addAccount=function(u){var f=new n.Deferred,e=i();return r({url:u.signInUrl+"?access_token="+e.access_token+"&returnurl="+encodeURIComponent(t.oauthParameters.redirectUri),redirectUri:t.oauthParameters.redirectUri,width:600,height:500}).then(function(){f.resolve()}),f.promise()};n.identityService=t})(jQuery);